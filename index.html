<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å°åŸå¸‚è–èª•åœ°åœ–</title>
<style>
  html, body { height: 100%; margin: 0; }
  #map { height: 100%; width: 100%; background: #eee; }

  #hint {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 5;
    background: white;
    padding: 8px 12px;
    border: 1px solid #ccc;
    font-size: 16px;
    font-weight: bold;
    transition: opacity 0.5s;
  }

  #shareBtn {
    position: absolute;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 5;
    padding: 12px 20px;
    background: #e53935;
    color: white;
    font-size: 18px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: background 0.5s, opacity 0.5s;
  }

  #shareBtn:hover { background: #d32f2f; }
</style>
</head>
<body>

<div id="map"></div>
<div id="hint">é»æ“Šè¨­å®šèµ·é» â†’ é»æ“Šè¨­å®šçµ‚é»</div>
<button id="shareBtn">ğŸ åˆ†äº«åœ°åœ–çµ¦æœ‹å‹ ğŸ</button>

<script>
let markers = [];
let pathLine = null;
let colors = ['#e53935','#fdd835','#43a047','#1e88e5'];
let colorIndex = 0;

// ç›´ç·šå‹•ç•«
function animateMarkerStraight(marker, start, end, duration) {
  const frames = 200;
  let count = 0;
  const latLngs = [];
  for (let i = 0; i <= frames; i++) {
    const lat = start.lat() + (end.lat() - start.lat()) * (i/frames);
    const lng = start.lng() + (end.lng() - start.lng()) * (i/frames);
    latLngs.push(new google.maps.LatLng(lat, lng));
  }
  const interval = setInterval(() => {
    if (count >= latLngs.length) clearInterval(interval);
    else marker.setPosition(latLngs[count++]);
  }, duration / frames);
}

// è§£æ URL åƒæ•¸
function getUrlCoords() {
  const params = new URLSearchParams(window.location.search);
  const startParam = params.get("start");
  const endParam = params.get("end");
  const centerParam = params.get("center");
  const zoomParam = params.get("zoom");
  
  if (!startParam || !endParam) return null;

  const [startLat, startLng] = startParam.split(",").map(Number);
  const [endLat, endLng] = endParam.split(",").map(Number);
  
  let center = null, zoom = null;
  if (centerParam && zoomParam) {
    const [centerLat, centerLng] = centerParam.split(",").map(Number);
    center = new google.maps.LatLng(centerLat, centerLng);
    zoom = Number(zoomParam);
  }

  return {
    start: new google.maps.LatLng(startLat, startLng),
    end: new google.maps.LatLng(endLat, endLng),
    center,
    zoom
  };
}

window.initMap = function() {
  const coords = getUrlCoords();
  const mapOptions = {
    center: coords && coords.center ? coords.center : { lat: 25.033964, lng: 121.564468 },
    zoom: coords && coords.zoom ? coords.zoom : 14
  };
  const map = new google.maps.Map(document.getElementById("map"), mapOptions);

  const hint = document.getElementById("hint");
  const shareBtn = document.getElementById("shareBtn");

  // å¦‚æœ URL æœ‰åº§æ¨™ï¼Œè‡ªå‹•å»ºç«‹æ¨™è¨˜èˆ‡è·¯ç·š
  if (coords) {
    // èµ·é»
    const startMarker = new google.maps.Marker({
      position: coords.start,
      map: map,
      icon: { url: "https://icons.iconarchive.com/icons/artdesigner/christmas/32/santa-icon.png", scaledSize: new google.maps.Size(32,32) }
    });
    markers.push(startMarker);

    // çµ‚é»
    const endMarker = new google.maps.Marker({
      position: coords.end,
      map: map,
      icon: { url: "https://icons.iconarchive.com/icons/psdblast/flat-christmas/32/reindeer-deer-icon.png", scaledSize: new google.maps.Size(32,32) }
    });
    markers.push(endMarker);

    // ç•«ç›´ç·šè·¯ç·š
    pathLine = new google.maps.Polyline({
      path: [coords.start, coords.end],
      geodesic: true,
      strokeColor: "#FF0000",
      strokeOpacity: 1.0,
      strokeWeight: 3,
      map: map
    });

    // éº‹é¹¿å¾èµ·é»ç§»å‹•åˆ°çµ‚é»
    endMarker.setPosition(coords.start);
    animateMarkerStraight(endMarker, coords.start, coords.end, 3000);

    // é¡¯ç¤ºåˆ†äº«æŒ‰éˆ•
    shareBtn.style.display = "block";
  }

  // é»æ“Šåœ°åœ–è¨­å®šæ¨™è¨˜
  map.addListener("click", function(event) {
    if (markers.length >= 2) {
      markers.forEach(m => m.setMap(null));
      markers = [];
      if (pathLine) pathLine.setMap(null);
      pathLine = null;
      hint.innerText = "é»æ“Šè¨­å®šèµ·é» â†’ é»æ“Šè¨­å®šçµ‚é»";
      hint.style.opacity = 1;
      shareBtn.style.display = "none";
    }

    const iconUrl = markers.length === 0
      ? "https://icons.iconarchive.com/icons/artdesigner/christmas/32/santa-icon.png"
      : "https://icons.iconarchive.com/icons/psdblast/flat-christmas/32/reindeer-deer-icon.png";

    const marker = new google.maps.Marker({
      position: event.latLng,
      map: map,
      icon: { url: iconUrl, scaledSize: new google.maps.Size(32,32) }
    });
    markers.push(marker);

    if (markers.length === 1) hint.innerText = "é»æ“Šè¨­å®šçµ‚é»";
    else if (markers.length === 2) {
      hint.style.opacity = 0;
      shareBtn.style.display = "block";
      shareBtn.style.opacity = 0;
      setTimeout(() => shareBtn.style.opacity = 1, 50);

      // åˆ†äº«æŒ‰éˆ•é–ƒå…‰
      setInterval(() => {
        shareBtn.style.background = colors[colorIndex];
        colorIndex = (colorIndex + 1) % colors.length;
      }, 500);

      const start = markers[0].getPosition();
      const end = markers[1].getPosition();

      pathLine = new google.maps.Polyline({
        path: [start, end],
        geodesic: true,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 3,
        map: map
      });

      const reindeer = markers[1];
      reindeer.setPosition(start);
      animateMarkerStraight(reindeer, start, end, 3000);
    }
  });

  // åˆ†äº«æŒ‰éˆ•ï¼šè‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œå¸¶å…¥ center å’Œ zoom
  shareBtn.addEventListener("click", async () => {
    if (markers.length < 2) return;
    const start = markers[0].getPosition();
    const end = markers[1].getPosition();
    const center = map.getCenter();
    const zoom = map.getZoom();
    const shareUrl = `${window.location.origin}${window.location.pathname}?start=${start.lat()},${start.lng()}&end=${end.lat()},${end.lng()}&center=${center.lat()},${center.lng()}&zoom=${zoom}`;
    
    try {
      await navigator.clipboard.writeText(shareUrl);
      alert("åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼ğŸ‰");
    } catch (err) {
      console.error("è¤‡è£½å¤±æ•—", err);
      alert("ç„¡æ³•è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚");
    }
  });
};
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQjNbg6Zn4742aG9zNQc1T7UzK-DcW100&callback=initMap" async defer></script>
</body>
</html>
